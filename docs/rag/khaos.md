# 云巢揭秘：数据库产品 PaaS On IaaS 实践分享

> 来源: https://cloud.tencent.com/developer/article/1832286

## 云巢是什么

云巢是腾讯云数据库产品中心基于 TKE 实现的 PaaS On IaaS 平台。随着2B行业的蓬勃发展，数据库产品中心原有烟囱式发展模式，在资源调度和统一管控上面临的挑战越来越多。同时腾讯云IaaS产品经过十几年的发展，可以提供可靠稳定的服务。当前 Kubernetes 已经成为资源编排的事实标准，TKE 产品形态在腾讯公有云运行多年，基于 TKE 实现数据库领域的 PaaS on IaaS 成为一个可行方案。

## 云巢平台解决的问题

1. 无法利用云上 IaaS 层的资源池和弹性扩缩容的能力，以及 IaaS 层成本和性能优化的红利。
2. 缺少统一的数据库 PaaS 平台，对多个产品、多个环境进行统一管控和调度。
3. 业务功能复用程度低，造成人力资源浪费。
4. 无法利用云原生红利，平台无法标准化，运维和交付成本比较高。

上述问题可以归纳为资源调度和统一的流程管控问题。

## 云巢 PaaS on IaaS 的优势

依赖云上 IaaS 层构建 PaaS 可以享受更多红利：

1. 弹性共有的资源池，解决传统资源池闲置成本。
2. 依赖 IaaS 基础稳定性，可以提供 SLA 的保障。
3. 依赖 IaaS 基础设施的完备，更快的构建 PaaS 层设施。
4. 依赖 IaaS 技术红利，快速享受云上成本优势。

目前云原生已经进入2.0时代，提供了标准的 Devops/存储/容器/编排等相关能力，同时 TKE 产品形态在腾讯公有云运行多年，经历众多客户的考验，稳定性值得认可。

## 云巢平台整体架构

云巢平台整体架构分为三个层面：

1. **业务接入层**：业务和控制台交互的接入层，比如参数控制/计费等业务特性功能。
2. **云巢 PaaS 层**：依赖云原生构建的 PaaS 平台。
3. **业务底层**：业务内核镜像以及监控数据采集实现和部署层。

核心组件包括：

- **scheduler**: 云巢资源调度器模块，依赖 K8S scheduler-framework 扩展实现，提供数据库实例拓扑装箱能力
- **cluster_manger**：数据库实例 CRD 的 controller，负责数据库实例 CRD 调协工作
- **sidecar-container**：云巢统一的 agent，提供命令接收和执行以及配置下载部署等工作
- **biz-container**：业务内核镜像，比如：redis/MySQL/Zookeeper 内核等

## 云巢资源管控平台

云巢资源管控平台只提供三个能力：

1. **资源管理**：提供 CRD (实例）的创建/升级/缩容/销毁等资源分配管理能力
2. **配置管理**：提供 CRD (实例)，业务配置模版渲染/版本/创建/更新/发布等能力，满足业务配置修改需求
3. **命令管理**：提供 CRD (实例)，同步/异步的任务下发和操作能力，比如重启 Biz-Container 等操作

所有的业务功能，围绕上层的三个能力进行业务逻辑构建。通过上述的抽象设计，业务只关心业务本身的业务比如主从关系/配置项操作等编排工作，云巢资源平台提供业务资源管理的原子接口。

## 云巢任务编排平台

云巢任务编排平台集成了 argo workflow。Argo 是 Applatix 推出的一个开源项目，为 Kubernetes 提供 container-native（工作流中的每个步骤是通过容器实现）工作流程。Argo 可以让用户用一个类似于传统的 YAML 文件定义的 DSL 来运行多个步骤的 Pipeline。该框架提供了复杂的循环、条件判断、依赖管理等功能。

Argo 的特点：

1. 使用 Kubernetes 自定义资源(CR)定义工作流，其中工作流中的每个步骤都是一个容器。
2. 将多步骤工作流建模为一系列任务，或者使用有向无环图（DAG）描述任务之间的依赖关系。
3. 可以在短时间内轻松运行用于机器学习或数据处理的计算密集型作业。
4. 可以通过 argo workflows 运行 CI/CD 流水线(Pipelines)。

## 云巢面临的技术挑战

云巢面临的技术挑战和解法分为两类：

1. **资源管理类**：满足产品基本诉求，比如多租户资源隔离，弹性资源调度等
2. **平台管控类**：关注平台本身的核心组件或者解决方案，比如配置中心/管控网络等

具体技术点包括：

- **弹性资源调度**：利用 K8s 的 kube-Scheduler 来满足数据库实例对资源装箱的要求
- **多租户资源隔离**：利用 namespace 技术和 cgroup 技术实现网络隔离和资源限制
- **数据存储层 PVC/PV**：通过 PV 来屏蔽具体存储层介质（云盘/本地盘等）
- **数据网络安全**：通过 K8s 的 network policy 能力提供用户间的网络隔离

## Sidecar 模式

云巢采用 Sidecar 模式而非富容器模式。Sidecar 模式是 Service Mesh 中习惯采用的模式，是容器设计模式的一种。Sidecar 应用与主应用程序松散耦合。它可以统一实现微服务的可观察性、监控、日志记录、配置、断路器等功能。

Sidecar 模式主要有以下优点：

1. 将与应用业务逻辑无关的功能抽象到共同基础设施降低了微服务代码的复杂度。
2. 因为不再需要编写相同的第三方组件配置文件和代码，所以能够降低微服务架构中的代码重复度。
3. 降低应用程序代码和底层平台的耦合度。

对比轻容器和富容器的特点，轻容器的灵活度更高，集中控制和约束能力更强。

## CRD 资源建模

云巢 CRD 资源建模：对于目前数据库常见类型基本上可以抽象为如下三层：

- **cluster**: 集群纬度，描述整个集群信息，一个 cluster 可能有1到 n 个 set 组成
- **set**: 一组同类型节点组成的 pod group，例如 clickhouse 中的 zookeeper set 就是由 n 个的 zookeeper-pod 节点组成。在这里使用 statefulset 的能力来管理 set
- **pod**: 具体承载业务应用的单元

Kubernetes 管理策略是一切皆对象（object)，所以可以基于 pod 最小对象单元，通过 set/cluster 等对象构建完成数据库集群 CRD 的定义。

## 配置中心

云巢配置中心是 PaaS 平台设计中的核心组件，它是业务解耦的关键。配置中心是把项目中各种配置、各种参数、各种开关，全部都放到一个集中的地方进行统一管理，并提供一套标准的接口。当各个服务需要获取配置的时候，就来配置中心的接口拉取。通过配置中心可以实现业务配置的统一管理，通过配置模版可以屏蔽业务配置逻辑。

业务配置修改一般经历如下步骤：

1. 用户通过 api-server 提供 CRD 参数修改。
2. 调谐器 watch 到 CRD 参数变化，此时会主动请求配置中心进行 CRD 的获取和配置模版的渲染工作。
3. 调谐器通过 agent 进行配置文件的下载和部署。
4. 调谐器通知配置部署结果。

## 新产品接入流程

云巢新产品接入流程大大得到简化，只需要经过三个步骤即可：

1. **配置接入**：依照产品配置进行模版配置
2. **默认 CRD 配置接入**：clusterpreset 主要是 CRD 的静态默认值，用户在创建 CRD 实例过程只需要关注少量的动态值：CPU/MEM/Volume 即可
3. **线上使用**：完成上述配置后即可线上使用

通过上述过程替换为其他产品，业务只需要提供产品的配置和内核镜像以及命令通道的编排即可实现一款新的产品上线。

## 未来展望

数据库产品中心目前有种类繁多的 TP 类数据库，并且在数据库产品领域经验沉淀多年。同时 HTAP 类数据库目前刚刚布局，PaaS 可以依赖新兴 HTAP 数据库进行打磨试点，同时随着 NewSQL 数据库产品 TDSQL V3 等的接入，可以补充 PaaS 平台在 TP 领域的布局，完善 PaaS 的周边生态，同时借助云原生红利（Istio，Chaos 等开源组件）踩在巨人肩膀上提供一个可行的 PaaS On IaaS 方案，为早日实现两朵云（公有云和专有云）的统一做一点贡献。
